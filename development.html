
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Development &#8212; imephu  documentation</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=84ace793992934648b4de8eed757e5a2" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx-book-theme.9d8b4a8b9bb19db25eeaddc40d639ba2.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="API" href="api.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<div class="col-12 col-md-3 bd-sidebar site-navigation " id="site-navigation">
    
        <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Content
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="quickstart.html">
   Quickstart
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="api.html">
   API
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Development
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<!-- This is an invisible pixel that we watch to see if we've scrolled. -->
<div class="sbt-scroll-pixel-helper"></div>
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            <div class="topbar-left">
                
                <label class="nav-toggle-button" for="__navigation">
                    <div class="visually-hidden">Toggle navigation</div>
                    <i class="fas fa-bars"></i>
                </label>
                
            </div>
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/development.md.txt"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setting-up-the-development-environment">
   Setting up the development environment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#development-tools">
   Development tools
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-with-tox">
   Testing with tox
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#unit-testing">
   Unit testing
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fixtures">
     Fixtures
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Development</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setting-up-the-development-environment">
   Setting up the development environment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#development-tools">
   Development tools
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-with-tox">
   Testing with tox
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#unit-testing">
   Unit testing
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fixtures">
     Fixtures
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="section" id="development">
<h1>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h1>
<div class="section" id="setting-up-the-development-environment">
<h2>Setting up the development environment<a class="headerlink" href="#setting-up-the-development-environment" title="Permalink to this headline">¶</a></h2>
<p>Make sure that all the Python versions supported by the plugin (3.8 to 3.10 at the time of writing) are installed on your computer and available to tox. <a class="reference external" href="https://asdf-vm.com">asdf</a> and <a class="reference external" href="https://github.com/brettcannon/python-launcher">python-launcher</a> can be of help in this regard.</p>
<p>Clone the project’s repository</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone git@github.com:saltastroops/imephu.git
</pre></div>
</div>
<p>Create a virtual repository named <code class="docutils literal notranslate"><span class="pre">.venv</span></code> in the cloned project:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> imephu
python -m venv .venv
</pre></div>
</div>
<p>While in principle another name could be chosen for the virtual environment, python-launcher will automatically pick up and use the virtual environment if it is called <code class="docutils literal notranslate"><span class="pre">.venv</span></code>.</p>
<p>Activate the virtual environment (just in case it isn’t picked up):</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> .venv/bin/activate
</pre></div>
</div>
<p>Now you can install the development requirements:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python -m pip install --upgrade pip
python -m pip install -r requirements-dev.txt
</pre></div>
</div>
<p>Finally, install the project package itself:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python -m pip install -e .
</pre></div>
</div>
</div>
<div class="section" id="development-tools">
<h2>Development tools<a class="headerlink" href="#development-tools" title="Permalink to this headline">¶</a></h2>
<p>After setting up the development environment, you have a variety of tools at your disposal. They are listed here along with the commands for using them.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Tool</p></th>
<th class="head"><p>Command</p></th>
<th class="head"><p>Use</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>black</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">black</span> <span class="pre">src</span> <span class="pre">tests</span></code></p></td>
<td><p>Format the code.</p></td>
</tr>
<tr class="row-odd"><td><p>flake8</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">flake8</span> <span class="pre">src</span> <span class="pre">tests</span></code></p></td>
<td><p>Check the code for linting issues.</p></td>
</tr>
<tr class="row-even"><td><p>isort</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">isort</span> <span class="pre">src</span> <span class="pre">tests</span></code></p></td>
<td><p>Sort the imports.</p></td>
</tr>
<tr class="row-odd"><td><p>mypy</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mypy</span> <span class="pre">src</span> <span class="pre">tests</span></code></p></td>
<td><p>Check the types.</p></td>
</tr>
<tr class="row-even"><td><p>pytest</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pytest</span></code></p></td>
<td><p>Run the unit tests.</p></td>
</tr>
<tr class="row-odd"><td><p>sphinx-build</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sphinx-build</span> <span class="pre">docs</span> <span class="pre">docs/build</span></code></p></td>
<td><p>Build the documentation.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="testing-with-tox">
<h2>Testing with tox<a class="headerlink" href="#testing-with-tox" title="Permalink to this headline">¶</a></h2>
<p>The following table lists the various tests which can be run with tox. The third column states whether you can replace the default positional arguments with your own ones. In most cases there should be no need for this, though.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Use</p></th>
<th class="head"><p>Own positional arguments?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">tox</span></code></p></td>
<td><p>Run unit tests for all Python versions.</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">tox</span> <span class="pre">-e</span> <span class="pre">docs</span></code></p></td>
<td><p>Check whether the documentation builds without warnings.</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">tox</span> <span class="pre">-e</span> <span class="pre">format</span></code></p></td>
<td><p>Check the code for formatting issues.</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">tox</span> <span class="pre">-e</span> <span class="pre">imports</span></code></p></td>
<td><p>Check the order of the import statements</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">tox</span> <span class="pre">-e</span> <span class="pre">lint</span></code></p></td>
<td><p>Check the code for linting issues.</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">tox</span> <span class="pre">-e</span> <span class="pre">typecheck</span></code></p></td>
<td><p>Check the types in the code (apart from tests).</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="unit-testing">
<h2>Unit testing<a class="headerlink" href="#unit-testing" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The project setup includes coverage for unit tests run with <code class="docutils literal notranslate"><span class="pre">tox</span></code>. This is not the case when <code class="docutils literal notranslate"><span class="pre">pytest</span></code> is run straight from the command line, as test coverage interferes with debugger breakpoints, causing code execution not to be paused at them. However, you may still include coverage by using the <code class="docutils literal notranslate"><span class="pre">--cov</span></code> flag.</p>
</div>
<p>Most of the unit tests create a finder chart, save it and compare it to a previously saved version, asserting nothing has changed. The pytest plugin <a class="reference external" href="https://pytest-regressions.readthedocs.io/en/latest/overview.html">pytest-regressions</a> is used for simplifying the task. The files created by this plugin should be put under version control.</p>
<p>The first time you save a particular finder chart, you will get an error like <code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">not</span> <span class="pre">found</span> <span class="pre">in</span> <span class="pre">data</span> <span class="pre">directory,</span> <span class="pre">created:</span></code>. In theory, you would expect that the next test run is passing. In practice, there is a problem. The <a class="reference internal" href="api.html#imephu.finder_chart.FinderChart" title="imephu.finder_chart.FinderChart"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FinderChart</span></code></a> class internally uses AstroPy’s <a class="reference external" href="https://docs.astropy.org/en/stable/visualization/index.html#module-astropy.visualization.mpl_normalize" title="(in Astropy v5.0)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">mpl_normalize</span></code></a> function, which is non-deterministic. This implies that the files generated by saving finder charts are not deterministic either; different runs of the code will create files which look the same, but have a different byte content (and even a different file size).</p>
<p>The solution is to set a random seed for the unit test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Bear in mind that <a class="reference external" href="https://towardsdatascience.com/stop-using-numpy-random-seed-581a9972805f">this is setting NumPy’s global random seed</a>, which may affect other code (but shouldn’t in the context of this project).</p>
<p>Rather than trying to remember to always set the random seed (and to remember how to use pytest-regressions), you can just use the <code class="docutils literal notranslate"><span class="pre">check_finder</span></code> fixture:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">imephu.finder_chart</span> <span class="kn">import</span> <span class="n">FinderChart</span>

<span class="k">def</span> <span class="nf">test_create_finder_chart</span><span class="p">(</span><span class="n">fits_file</span><span class="p">,</span> <span class="n">check_finder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">FinderChart</span><span class="p">(</span><span class="n">fits_file</span><span class="p">)</span>
    <span class="n">check_finder</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>
</pre></div>
</div>
<p>If you need to update the files generated by pytest-regressions, you may run <code class="docutils literal notranslate"><span class="pre">pytest</span></code> with the <code class="docutils literal notranslate"><span class="pre">--force-regen</span></code> flag:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pytest --force-regen
</pre></div>
</div>
<p>In case you are using parametrized tests and want to have more meaningful names for the generated files, you may use the <code class="docutils literal notranslate"><span class="pre">ids</span></code> keyword of the <code class="docutils literal notranslate"><span class="pre">parametrized</span></code> marker.</p>
<div class="section" id="fixtures">
<h3>Fixtures<a class="headerlink" href="#fixtures" title="Permalink to this headline">¶</a></h3>
<p>The following fixtures are defined in <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code>.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Fixture</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>check_finder</p></td>
<td><p>Function comparing a finder chart against a previously saved version, asserting nothing has changed. (Technically, the saved png file is compared.)</p></td>
</tr>
<tr class="row-odd"><td><p>fits_file</p></td>
<td><p><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Path</span></code></a> of a FITS file that can be used for generating a finder chart.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="api.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">API</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Southern African Large Telescope (SALT)<br/>
    
        &copy; Copyright 2022, Southern African Large Telescope (SALT).<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>