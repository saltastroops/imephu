@Library('saao-shared-library') _

pipeline {
  agent none

  stages {
    agent {
      dockerfile {
        filename 'Dockerfile'
        dir 'jenkins/deployment'
        args '-v imephu-venv:/venv -u 0:0'
      }
    }

    stage('Run tests') {
      steps {
        sh 'poetry export -f requirements.txt --with dev --output requirements.txt'
        sh 'pip install -r requirements.txt'
        script {
          saao.runTests(
            'black': ['src', 'tests'],
            'mypy': ['src', 'tests'],
            'pytest': ['tests'],
            'ruff':['src', 'tests']
          )
        }
      }
    }
  }

  post {
    always {
      script {
        generatePythonTestReports()
      }
    }
  }
}
